================================================================================
FILE: localollama/settings.py
================================================================================
from pathlib import Path
import os
from dotenv import load_dotenv

BASE_DIR = Path(__file__).resolve().parent.parent
load_dotenv(BASE_DIR / ".env")

SECRET_KEY = os.getenv("DJANGO_SECRET_KEY", "change-me")
DEBUG = os.getenv("DJANGO_DEBUG", "0") == "1"

ALLOWED_HOSTS = [h.strip() for h in os.getenv("DJANGO_ALLOWED_HOSTS", "localhost,127.0.0.1").split(",") if h.strip()]

INSTALLED_APPS = [
    "django.contrib.admin",
    "django.contrib.auth",
    "django.contrib.contenttypes",
    "django.contrib.sessions",
    "django.contrib.messages",
    "django.contrib.staticfiles",
    "corsheaders",
    "rest_framework",
    "chat",
]

MIDDLEWARE = [
    "corsheaders.middleware.CorsMiddleware",
    "django.middleware.security.SecurityMiddleware",
    "django.contrib.sessions.middleware.SessionMiddleware",
    "django.middleware.common.CommonMiddleware",
    "django.middleware.csrf.CsrfViewMiddleware",
    "django.contrib.auth.middleware.AuthenticationMiddleware",
    "django.contrib.messages.middleware.MessageMiddleware",
    "django.middleware.clickjacking.XFrameOptionsMiddleware",
]

ROOT_URLCONF = "localollama.urls"

TEMPLATES = [
    {
        "BACKEND": "django.template.backends.django.DjangoTemplates",
        "DIRS": [],
        "APP_DIRS": True,
        "OPTIONS": {
            "context_processors": [
                "django.template.context_processors.request",
                "django.contrib.auth.context_processors.auth",
                "django.contrib.messages.context_processors.messages",
            ],
        },
    },
]

WSGI_APPLICATION = "localollama.wsgi.application"
ASGI_APPLICATION = "localollama.asgi.application"

DATABASES = {
    "default": {
        "ENGINE": "django.db.backends.postgresql",
        "NAME": os.getenv("DB_NAME", "ollama_chat"),
        "USER": os.getenv("DB_USER", "ollama"),
        "PASSWORD": os.getenv("DB_PASSWORD", "ollama"),
        "HOST": os.getenv("DB_HOST", "localhost"),
        "PORT": os.getenv("DB_PORT", "5432"),
    }
}

AUTH_PASSWORD_VALIDATORS = []

LANGUAGE_CODE = "es-cl"
TIME_ZONE = "America/Santiago"
USE_I18N = True
USE_TZ = True

STATIC_URL = "static/"
DEFAULT_AUTO_FIELD = "django.db.models.BigAutoField"

REST_FRAMEWORK = {
    "DEFAULT_AUTHENTICATION_CLASSES": [],
    "DEFAULT_PERMISSION_CLASSES": ["rest_framework.permissions.AllowAny"],
}

CORS_ALLOW_ALL_ORIGINS = False
CORS_ALLOWED_ORIGINS = [
    "http://localhost:5173",
    "http://127.0.0.1:5173",
]


================================================================================
FILE: localollama/urls.py
================================================================================
from django.contrib import admin
from django.urls import path, include

urlpatterns = [
    path("admin/", admin.site.urls),
    path("api/", include("chat.urls")),
]


================================================================================
FILE: localollama/wsgi.py
================================================================================
import os
from django.core.wsgi import get_wsgi_application

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "localollama.settings")
application = get_wsgi_application()


================================================================================
FILE: localollama/asgi.py
================================================================================
import os
from django.core.asgi import get_asgi_application

os.environ.setdefault("DJANGO_SETTINGS_MODULE", "localollama.settings")
application = get_asgi_application()


================================================================================
FILE: requirements.txt
================================================================================
Django>=5.0,<6.0
djangorestframework>=3.15,<4.0
django-cors-headers>=4.4,<5.0
psycopg[binary]>=3.2,<4.0
python-dotenv>=1.0,<2.0
requests>=2.32,<3.0


================================================================================
FILE: manage.py
================================================================================
#!/usr/bin/env python
import os
import sys
from pathlib import Path

def main():
    base_dir = Path(__file__).resolve().parent
    try:
        from dotenv import load_dotenv
        load_dotenv(base_dir / ".env")
    except Exception:
        pass

    os.environ.setdefault("DJANGO_SETTINGS_MODULE", "localollama.settings")
    from django.core.management import execute_from_command_line
    execute_from_command_line(sys.argv)

if __name__ == "__main__":
    main()


================================================================================
FILE: chat/models.py
================================================================================
import uuid
from django.db import models

class ChatSession(models.Model):
    id = models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False)
    title = models.CharField(max_length=200, blank=True, default="")
    custom_instructions = models.TextField(blank=True, default="")
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ["-created_at"]

    def __str__(self) -> str:
        return self.title or f"Session {self.id}"

class ChatMessage(models.Model):
    ROLE_USER = "user"
    ROLE_ASSISTANT = "assistant"
    ROLE_SYSTEM = "system"
    ROLE_CHOICES = [
        (ROLE_USER, "User"),
        (ROLE_ASSISTANT, "Assistant"),
        (ROLE_SYSTEM, "System"),
    ]

    session = models.ForeignKey(ChatSession, on_delete=models.CASCADE, related_name="messages")
    role = models.CharField(max_length=20, choices=ROLE_CHOICES)
    content = models.TextField()
    created_at = models.DateTimeField(auto_now_add=True)

    class Meta:
        ordering = ["created_at"]

    def __str__(self) -> str:
        return f"{self.role}: {self.content[:40]}".strip()

================================================================================
FILE: chat/migrations/0001_initial.py
================================================================================
# Generated manually
from django.db import migrations, models
import django.db.models.deletion
import uuid

class Migration(migrations.Migration):

    initial = True

    dependencies = [
    ]

    operations = [
        migrations.CreateModel(
            name='ChatSession',
            fields=[
                ('id', models.UUIDField(primary_key=True, default=uuid.uuid4, editable=False, serialize=False)),
                ('title', models.CharField(blank=True, default='', max_length=200)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
            ],
            options={
                'ordering': ['-created_at'],
            },
        ),
        migrations.CreateModel(
            name='ChatMessage',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('role', models.CharField(choices=[('user', 'User'), ('assistant', 'Assistant'), ('system', 'System')], max_length=20)),
                ('content', models.TextField()),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('session', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='messages', to='chat.chatsession')),
            ],
            options={
                'ordering': ['created_at'],
            },
        ),
    ]


================================================================================
FILE: chat/migrations/0002_chatsession_custom_instructions.py
================================================================================
from django.db import migrations, models

class Migration(migrations.Migration):

    dependencies = [
        ("chat", "0001_initial"),
    ]

    operations = [
        migrations.AddField(
            model_name="chatsession",
            name="custom_instructions",
            field=models.TextField(blank=True, default=""),
        ),
    ]

================================================================================
FILE: chat/admin.py
================================================================================
from django.contrib import admin
from .models import ChatSession, ChatMessage

@admin.register(ChatSession)
class ChatSessionAdmin(admin.ModelAdmin):
    list_display = ("id", "title", "created_at")
    search_fields = ("id", "title")
    ordering = ("-created_at",)

@admin.register(ChatMessage)
class ChatMessageAdmin(admin.ModelAdmin):
    list_display = ("id", "session", "role", "created_at")
    search_fields = ("content",)
    list_filter = ("role", "created_at")
    ordering = ("-created_at",)


================================================================================
FILE: chat/urls.py
================================================================================
from django.urls import path
from .views import HealthView, SessionListCreateView, SessionDetailView, SessionMessagesView, ChatView

urlpatterns = [
    path("health/", HealthView.as_view(), name="health"),
    path("sessions/", SessionListCreateView.as_view(), name="sessions"),
    path("sessions/<uuid:session_id>/", SessionDetailView.as_view(), name="session-detail"),
    path("sessions/<uuid:session_id>/messages/", SessionMessagesView.as_view(), name="session-messages"),
    path("sessions/<uuid:session_id>/chat/", ChatView.as_view(), name="chat"),
]

================================================================================
FILE: chat/apps.py
================================================================================
from django.apps import AppConfig

class ChatConfig(AppConfig):
    default_auto_field = "django.db.models.BigAutoField"
    name = "chat"


================================================================================
FILE: chat/views.py
================================================================================
import json
import os
import requests
from django.http import StreamingHttpResponse
from rest_framework.views import APIView
from rest_framework.response import Response
from rest_framework import status
from .models import ChatSession, ChatMessage
from .serializers import ChatSessionSerializer, ChatMessageSerializer

def _ollama_cfg():
    base_url = os.getenv("OLLAMA_BASE_URL", "http://localhost:11434").rstrip("/")
    model = os.getenv("OLLAMA_MODEL", "huihui_ai/deepseek-r1-abliterated:14b")
    timeout = int(os.getenv("OLLAMA_TIMEOUT", "120"))
    max_hist = int(os.getenv("OLLAMA_MAX_HISTORY_MESSAGES", "20"))
    system_prompt = os.getenv("OLLAMA_SYSTEM_PROMPT", "").strip()
    return base_url, model, timeout, max_hist, system_prompt

def _build_messages_from_db(session: ChatSession):
    _, _, _, max_hist, env_system_prompt = _ollama_cfg()
    msgs = []

    parts = []
    if env_system_prompt:
        parts.append(env_system_prompt.strip())

    custom = (session.custom_instructions or "").strip()
    if custom:
        parts.append("Instrucciones personalizadas:\n" + custom)

    if parts:
        msgs.append({"role": "system", "content": "\n\n".join(parts)})

    history = list(session.messages.order_by("-created_at")[:max_hist])
    history.reverse()
    for m in history:
        msgs.append({"role": m.role, "content": m.content})
    return msgs

def _ollama_chat(messages, stream: bool):
    base_url, model, timeout, _, _ = _ollama_cfg()
    url = f"{base_url}/api/chat"
    payload = {
        "model": model,
        "messages": messages,
        "stream": bool(stream),
    }
    # Ollama devuelve JSONL cuando stream=true
    return requests.post(url, json=payload, stream=stream, timeout=timeout)

class HealthView(APIView):
    def get(self, request):
        base_url, model, timeout, *_ = _ollama_cfg()
        return Response({"status": "ok", "ollama_base_url": base_url, "model": model, "timeout": timeout})

class SessionListCreateView(APIView):
    def get(self, request):
        sessions = ChatSession.objects.all()
        return Response(ChatSessionSerializer(sessions, many=True).data)

    def post(self, request):
        title = (request.data.get("title") or "").strip()
        custom_instructions = (request.data.get("custom_instructions") or "").strip()
        s = ChatSession.objects.create(title=title, custom_instructions=custom_instructions)
        return Response(ChatSessionSerializer(s).data, status=status.HTTP_201_CREATED)

class SessionDetailView(APIView):
    def get(self, request, session_id):
        try:
            s = ChatSession.objects.get(id=session_id)
        except ChatSession.DoesNotExist:
            return Response({"detail": "Session not found"}, status=status.HTTP_404_NOT_FOUND)
        return Response(ChatSessionSerializer(s).data)

    def patch(self, request, session_id):
        try:
            s = ChatSession.objects.get(id=session_id)
        except ChatSession.DoesNotExist:
            return Response({"detail": "Session not found"}, status=status.HTTP_404_NOT_FOUND)

        if "title" in request.data:
            s.title = (request.data.get("title") or "").strip()

        if "custom_instructions" in request.data:
            s.custom_instructions = (request.data.get("custom_instructions") or "").strip()

        s.save()
        return Response(ChatSessionSerializer(s).data)

    def delete(self, request, session_id):
        try:
            s = ChatSession.objects.get(id=session_id)
        except ChatSession.DoesNotExist:
            return Response({"detail": "Session not found"}, status=status.HTTP_404_NOT_FOUND)
        s.delete()
        return Response(status=status.HTTP_204_NO_CONTENT)

class SessionMessagesView(APIView):
    def get(self, request, session_id):
        try:
            s = ChatSession.objects.get(id=session_id)
        except ChatSession.DoesNotExist:
            return Response({"detail": "Session not found"}, status=status.HTTP_404_NOT_FOUND)
        msgs = s.messages.all()
        return Response(ChatMessageSerializer(msgs, many=True).data)

class ChatView(APIView):
    def post(self, request, session_id):
        content = (request.data.get("content") or "").strip()
        if not content:
            return Response({"detail": "content is required"}, status=status.HTTP_400_BAD_REQUEST)

        try:
            s = ChatSession.objects.get(id=session_id)
        except ChatSession.DoesNotExist:
            return Response({"detail": "Session not found"}, status=status.HTTP_404_NOT_FOUND)

        # guarda mensaje usuario
        ChatMessage.objects.create(session=s, role=ChatMessage.ROLE_USER, content=content)

        # auto-título si está vacío
        if not s.title:
            s.title = (content[:60]).strip()
            s.save(update_fields=["title"])

        stream = request.query_params.get("stream") in ("1", "true", "yes")
        messages = _build_messages_from_db(s)

        if stream:
            def event_stream():
                full = []
                try:
                    r = _ollama_chat(messages, stream=True)
                    r.raise_for_status()
                    for line in r.iter_lines(decode_unicode=True):
                        if not line:
                            continue
                        obj = json.loads(line)
                        delta = (obj.get("message") or {}).get("content") or ""
                        if delta:
                            full.append(delta)
                            yield f"data: {json.dumps({'delta': delta})}\n\n"
                        if obj.get("done"):
                            break
                except Exception as e:
                    yield f"data: {json.dumps({'error': str(e)})}\n\n"
                finally:
                    assistant_text = "".join(full).strip()
                    if assistant_text:
                        ChatMessage.objects.create(session=s, role=ChatMessage.ROLE_ASSISTANT, content=assistant_text)
                    yield "data: [DONE]\n\n"

            resp = StreamingHttpResponse(event_stream(), content_type="text/event-stream")
            resp["Cache-Control"] = "no-cache"
            return resp

        # no streaming: stream=false
        try:
            r = _ollama_chat(messages, stream=False)
            r.raise_for_status()
            data = r.json()
            assistant_text = ((data.get("message") or {}).get("content") or "").strip()
        except Exception as e:
            return Response({"detail": "Ollama error", "error": str(e)}, status=status.HTTP_502_BAD_GATEWAY)

        ChatMessage.objects.create(session=s, role=ChatMessage.ROLE_ASSISTANT, content=assistant_text)
        return Response({"assistant": assistant_text})

================================================================================
FILE: chat/serializers.py
================================================================================
from rest_framework import serializers
from .models import ChatSession, ChatMessage

class ChatMessageSerializer(serializers.ModelSerializer):
    class Meta:
        model = ChatMessage
        fields = ["id", "role", "content", "created_at"]

class ChatSessionSerializer(serializers.ModelSerializer):
    last_message = serializers.SerializerMethodField()

    class Meta:
        model = ChatSession
        fields = ["id", "title", "custom_instructions", "created_at", "last_message"]

    def get_last_message(self, obj):
        msg = obj.messages.order_by("-created_at").first()
        if not msg:
            return None
        return {"role": msg.role, "content": msg.content, "created_at": msg.created_at}

