================================================================================
FILE: index.html
================================================================================
<!doctype html>
<html lang="es">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Ollama Local Chat</title>
  </head>
  <body>
    <div id="root"></div>
    <script type="module" src="/src/main.jsx"></script>
  </body>
</html>


================================================================================
FILE: vite.config.js
================================================================================
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'

export default defineConfig({
  plugins: [react()],
  server: {
    port: 5173,
    proxy: {
      '/api': {
        target: process.env.VITE_API_PROXY_TARGET || 'http://localhost:8000',
        changeOrigin: true
      }
    }
  }
})


================================================================================
FILE: src/styles.css
================================================================================
/* minimal, limpio, sin frameworks */
:root {
  font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
  line-height: 1.4;
  color: #111827;
  background: #0b1020;
}

* {
  box-sizing: border-box;
}

body {
  margin: 0;
  background: radial-gradient(1200px 700px at 20% 10%, rgba(79, 70, 229, 0.25), transparent 60%),
    radial-gradient(1200px 700px at 80% 90%, rgba(16, 185, 129, 0.20), transparent 60%),
    #0b1020;
}

.app {
  height: 100vh;
  display: grid;
  grid-template-columns: 320px 1fr;
}

.sidebar {
  border-right: 1px solid rgba(255, 255, 255, 0.08);
  background: rgba(255, 255, 255, 0.04);
  backdrop-filter: blur(10px);
  padding: 16px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.brand-title {
  font-size: 18px;
  font-weight: 700;
  color: rgba(255, 255, 255, 0.92);
}

.brand-sub {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.60);
}

.btn {
  appearance: none;
  border: 1px solid rgba(255, 255, 255, 0.14);
  background: rgba(255, 255, 255, 0.06);
  color: rgba(255, 255, 255, 0.92);
  padding: 10px 12px;
  border-radius: 12px;
  cursor: pointer;
  transition: transform .05s ease, background .15s ease, border-color .15s ease;
}

.btn:hover {
  background: rgba(255, 255, 255, 0.10);
  border-color: rgba(255, 255, 255, 0.20);
}

.btn:active {
  transform: translateY(1px);
}

.btn.primary {
  background: rgba(79, 70, 229, 0.55);
  border-color: rgba(79, 70, 229, 0.65);
}

.btn.primary:hover {
  background: rgba(79, 70, 229, 0.70);
}

.btn.danger {
  background: rgba(239, 68, 68, 0.22);
  border-color: rgba(239, 68, 68, 0.38);
}

.btn.danger:hover {
  background: rgba(239, 68, 68, 0.30);
  border-color: rgba(239, 68, 68, 0.50);
}

.btn:disabled {
  opacity: .6;
  cursor: not-allowed;
}

.sessions {
  display: flex;
  flex-direction: column;
  gap: 8px;
  overflow: auto;
  padding-right: 2px;
}

.session-row {
  display: grid;
  grid-template-columns: 1fr 40px;
  gap: 8px;
  align-items: stretch;
}

.session-select {
  text-align: left;
  padding: 10px 10px;
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.10);
  background: rgba(255, 255, 255, 0.03);
  color: rgba(255, 255, 255, 0.9);
  cursor: pointer;
}

.session-select:hover {
  background: rgba(255, 255, 255, 0.06);
}

.session-select.active {
  border-color: rgba(16, 185, 129, 0.55);
  background: rgba(16, 185, 129, 0.12);
}

.session-title {
  font-weight: 700;
  font-size: 13px;
}

.session-last {
  margin-top: 4px;
  font-size: 12px;
  color: rgba(255, 255, 255, 0.65);
}

.session-del {
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.10);
  background: rgba(239, 68, 68, 0.14);
  color: rgba(255, 255, 255, 0.92);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

.session-del:hover {
  background: rgba(239, 68, 68, 0.22);
  border-color: rgba(239, 68, 68, 0.35);
}

.session-del:disabled {
  opacity: .6;
  cursor: not-allowed;
}

.sidebar-footer {
  margin-top: auto;
  font-size: 12px;
  color: rgba(255, 255, 255, 0.55);
}

.instructions {
  border: 1px solid rgba(255, 255, 255, 0.10);
  background: rgba(255, 255, 255, 0.03);
  border-radius: 14px;
  padding: 10px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.instructions-head {
  display: flex;
  align-items: baseline;
  justify-content: space-between;
  gap: 10px;
}

.instructions-title {
  font-size: 12px;
  font-weight: 700;
  color: rgba(255, 255, 255, 0.88);
}

.instructions-sub {
  font-size: 11px;
  color: rgba(255, 255, 255, 0.55);
}

.instructions-actions {
  display: grid;
  grid-template-columns: 1fr 120px;
  gap: 8px;
  align-items: start;
}

.instructions-textarea {
  min-height: 92px;
}

.main {
  display: grid;
  grid-template-rows: 56px 1fr auto;
  height: 100vh;
}

.topbar {
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  background: rgba(0, 0, 0, 0.10);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 16px;
  gap: 12px;
}

.topbar-title {
  color: rgba(255, 255, 255, 0.92);
  font-weight: 700;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.topbar-right {
  display: flex;
  align-items: center;
  gap: 10px;
}

.pill {
  font-size: 12px;
  padding: 6px 10px;
  border-radius: 999px;
  border: 1px solid rgba(255, 255, 255, 0.14);
  color: rgba(255, 255, 255, 0.75);
}

.pill-live {
  border-color: rgba(16, 185, 129, 0.50);
  background: rgba(16, 185, 129, 0.12);
  color: rgba(255, 255, 255, 0.90);
}

.chat {
  padding: 18px 18px 8px;
  overflow: auto;
}

.msg-row {
  display: flex;
  margin: 8px 0 2px;
}

.msg-row.left {
  justify-content: flex-start;
}

.msg-row.right {
  justify-content: flex-end;
}

.msg {
  width: min(760px, 92%);
  border-radius: 18px;
  padding: 12px 14px;
  border: 1px solid rgba(255, 255, 255, 0.10);
  background: rgba(255, 255, 255, 0.06);
  color: rgba(255, 255, 255, 0.92);
  white-space: pre-wrap;
  word-break: break-word;
}

.msg.user {
  background: rgba(79, 70, 229, 0.18);
  border-color: rgba(79, 70, 229, 0.28);
}

.msg.assistant {
  background: rgba(255, 255, 255, 0.06);
}

.msg-role {
  font-size: 12px;
  font-weight: 700;
  color: rgba(255, 255, 255, 0.65);
  margin-bottom: 6px;
}

.msg-content {
  font-size: 14px;
}

.msg-time {
  font-size: 11px;
  color: rgba(255, 255, 255, 0.45);
  margin: 0 8px 8px;
}

.composer {
  border-top: 1px solid rgba(255, 255, 255, 0.08);
  background: rgba(0, 0, 0, 0.14);
  backdrop-filter: blur(10px);
  padding: 12px 16px 14px;
}

.composer-row {
  display: grid;
  grid-template-columns: 1fr 120px;
  gap: 10px;
}

.input {
  width: 100%;
  resize: none;
  border-radius: 14px;
  padding: 10px 12px;
  border: 1px solid rgba(255, 255, 255, 0.14);
  background: rgba(255, 255, 255, 0.06);
  color: rgba(255, 255, 255, 0.92);
  outline: none;
}

.input:focus {
  border-color: rgba(16, 185, 129, 0.55);
  box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.15);
}

.error {
  margin-bottom: 10px;
  padding: 10px 12px;
  border-radius: 14px;
  border: 1px solid rgba(239, 68, 68, 0.40);
  background: rgba(239, 68, 68, 0.14);
  color: rgba(255, 255, 255, 0.92);
  font-size: 13px;
}

.muted {
  margin-top: 8px;
  font-size: 12px;
  color: rgba(255, 255, 255, 0.55);
}

/* responsive */
@media (max-width: 900px) {
  .app {
    grid-template-columns: 1fr;
  }

  .sidebar {
    display: none;
  }
}

================================================================================
FILE: src/App.jsx
================================================================================
import React, { useEffect, useMemo, useRef, useState } from 'react'
import { createSession, deleteSession, getMessages, listSessions, sendMessageStream, updateSession } from './api.js'

function formatDate(iso) {
  try {
    return new Date(iso).toLocaleString()
  } catch {
    return iso
  }
}

function MessageBubble({ role, content }) {
  const isUser = role === 'user'
  return (
    <div className={`msg-row ${isUser ? 'right' : 'left'}`}>
      <div className={`msg ${isUser ? 'user' : 'assistant'}`}>
        <div className="msg-role">{isUser ? 'Tú' : 'IA'}</div>
        <div className="msg-content">{content}</div>
      </div>
    </div>
  )
}

export default function App() {
  const [sessions, setSessions] = useState([])
  const [activeSessionId, setActiveSessionId] = useState(null)
  const [messages, setMessages] = useState([])
  const [input, setInput] = useState('')
  const [loading, setLoading] = useState(false)
  const [error, setError] = useState('')

  const [defaultInstructions, setDefaultInstructions] = useState('')
  const [instructionsText, setInstructionsText] = useState('')
  const [instructionsDirty, setInstructionsDirty] = useState(false)

  const bottomRef = useRef(null)

  const activeSession = useMemo(() => {
    return sessions.find((x) => x.id === activeSessionId) || null
  }, [sessions, activeSessionId])

  async function refreshSessions(preferId) {
    const s = await listSessions()
    setSessions(s)

    const desired = preferId || activeSessionId
    if (desired && s.some((x) => x.id === desired)) {
      setActiveSessionId(desired)
      return
    }
    if (s.length) {
      setActiveSessionId(s[0].id)
      return
    }
    setActiveSessionId(null)
  }

  useEffect(() => {
    try {
      const saved = localStorage.getItem('ollama_default_instructions') || ''
      setDefaultInstructions(saved)
    } catch {
      setDefaultInstructions('')
    }
  }, [])

  useEffect(() => {
    refreshSessions()
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [])

  useEffect(() => {
    async function load() {
      if (!activeSessionId) {
        setMessages([])
        return
      }
      const msgs = await getMessages(activeSessionId)
      setMessages(msgs)
      setTimeout(() => bottomRef.current?.scrollIntoView({ behavior: 'smooth' }), 50)
    }
    load()
  }, [activeSessionId])

  useEffect(() => {
    // Sincroniza instrucciones del chat activo (o default si no hay chat activo)
    if (activeSessionId && activeSession) {
      setInstructionsText(activeSession.custom_instructions || '')
      setInstructionsDirty(false)
      return
    }
    setInstructionsText(defaultInstructions || '')
    setInstructionsDirty(false)
  }, [activeSessionId, activeSession, defaultInstructions])

  async function onNewChat() {
    setError('')
    try {
      const s = await createSession({ title: '', custom_instructions: defaultInstructions || '' })
      await refreshSessions(s.id)
      setMessages([])
    } catch (e) {
      setError(String(e.message || e))
    }
  }

  async function onDeleteChat(sessionId) {
    if (!sessionId) return
    const s = sessions.find((x) => x.id === sessionId)
    const label = s?.title ? `"${s.title}"` : String(sessionId)
    const ok = window.confirm(`¿Eliminar este chat y todos sus mensajes?\n\n${label}`)
    if (!ok) return

    setError('')
    try {
      await deleteSession(sessionId)
      const deletingActive = sessionId === activeSessionId
      await refreshSessions(deletingActive ? null : activeSessionId)
      if (deletingActive) setMessages([])
    } catch (e) {
      setError(String(e.message || e))
    }
  }

  async function onSaveInstructions() {
    setError('')
    try {
      if (activeSessionId && activeSession) {
        await updateSession(activeSessionId, { custom_instructions: instructionsText || '' })
        await refreshSessions(activeSessionId)
        setInstructionsDirty(false)
        return
      }

      // No hay chat activo: guardar como default para nuevos chats
      try {
        localStorage.setItem('ollama_default_instructions', instructionsText || '')
      } catch {
        // ignore
      }
      setDefaultInstructions(instructionsText || '')
      setInstructionsDirty(false)
    } catch (e) {
      setError(String(e.message || e))
    }
  }

  async function onSend() {
    const text = input.trim()
    if (!text || loading) return

    setError('')
    setLoading(true)
    setInput('')

    try {
      let sid = activeSessionId
      if (!sid) {
        const s = await createSession({ title: '', custom_instructions: defaultInstructions || '' })
        sid = s.id
        await refreshSessions(sid)
      }

      // agrega mensaje usuario inmediatamente
      const tempUser = { id: `tmp-u-${Date.now()}`, role: 'user', content: text, created_at: new Date().toISOString() }
      const tempAsst = { id: `tmp-a-${Date.now()}`, role: 'assistant', content: '', created_at: new Date().toISOString() }
      setMessages((prev) => [...prev, tempUser, tempAsst])

      // streaming
      await sendMessageStream(sid, text, (delta) => {
        setMessages((prev) => {
          const copy = [...prev]
          const idx = copy.findIndex((m) => m.id === tempAsst.id)
          if (idx >= 0) copy[idx] = { ...copy[idx], content: copy[idx].content + delta }
          return copy
        })
        bottomRef.current?.scrollIntoView({ behavior: 'smooth' })
      })

      // refresca desde BD (para tener ids reales y título actualizado)
      await refreshSessions(sid)
      const msgs = await getMessages(sid)
      setMessages(msgs)
      setTimeout(() => bottomRef.current?.scrollIntoView({ behavior: 'smooth' }), 50)
    } catch (e) {
      setError(String(e.message || e))
    } finally {
      setLoading(false)
    }
  }

  const activeTitle = useMemo(() => {
    const s = sessions.find((x) => x.id === activeSessionId)
    return s?.title || 'Chat'
  }, [sessions, activeSessionId])

  const instructionsLabel = useMemo(() => {
    if (activeSessionId && activeSession) return 'Instrucciones personalizadas (este chat)'
    return 'Instrucciones personalizadas (por defecto)'
  }, [activeSessionId, activeSession])

  const instructionsSub = useMemo(() => {
    if (activeSessionId && activeSession) return 'Se inyectan como “system prompt” al modelo'
    return 'Se aplican automáticamente al crear un chat nuevo'
  }, [activeSessionId, activeSession])

  return (
    <div className="app">
      <aside className="sidebar">
        <div className="brand">
          <div className="brand-title">Ollama Local Chat</div>
          <div className="brand-sub">Django + React + Postgres</div>
        </div>

        <button className="btn" onClick={onNewChat}>Nuevo chat</button>

        <div className="instructions">
          <div className="instructions-head">
            <div className="instructions-title">{instructionsLabel}</div>
            <div className="instructions-sub">{instructionsSub}</div>
          </div>

          <div className="instructions-actions">
            <textarea
              className="input instructions-textarea"
              placeholder="Ej: Responde en español, sé conciso, usa bullets, etc."
              value={instructionsText}
              onChange={(e) => {
                setInstructionsText(e.target.value)
                setInstructionsDirty(true)
              }}
              rows={4}
              disabled={loading}
            />
            <button
              className="btn primary"
              onClick={onSaveInstructions}
              disabled={loading || !instructionsDirty}
              title={activeSessionId ? 'Guarda instrucciones para este chat' : 'Guarda instrucciones por defecto'}
            >
              Guardar
            </button>
          </div>
        </div>

        <div className="sessions">
          {sessions.map((s) => (
            <div key={s.id} className="session-row">
              <button
                className={`session-select ${s.id === activeSessionId ? 'active' : ''}`}
                onClick={() => setActiveSessionId(s.id)}
                title={s.title || s.id}
              >
                <div className="session-title">{s.title || '(sin título)'}</div>
                {s.last_message ? (
                  <div className="session-last">{s.last_message.role}: {s.last_message.content.slice(0, 50)}</div>
                ) : (
                  <div className="session-last">Sin mensajes</div>
                )}
              </button>

              <button
                className="session-del"
                onClick={() => onDeleteChat(s.id)}
                disabled={loading}
                title="Eliminar chat"
              >
                ×
              </button>
            </div>
          ))}
        </div>

        <div className="sidebar-footer">
          <div className="muted">Tip: si no responde, revisa que Ollama esté en http://localhost:11434</div>
        </div>
      </aside>

      <main className="main">
        <header className="topbar">
          <div className="topbar-title">{activeTitle}</div>
          <div className="topbar-right">
            {activeSessionId ? (
              <button
                className="btn danger"
                onClick={() => onDeleteChat(activeSessionId)}
                disabled={loading}
                title="Eliminar chat actual"
              >
                Eliminar chat
              </button>
            ) : null}
            <span className={`pill ${loading ? 'pill-live' : ''}`}>{loading ? 'Generando...' : 'Listo'}</span>
          </div>
        </header>

        <section className="chat">
          {messages.map((m) => (
            <div key={m.id}>
              <MessageBubble role={m.role} content={m.content} />
              <div className="msg-time">{formatDate(m.created_at)}</div>
            </div>
          ))}
          <div ref={bottomRef} />
        </section>

        <footer className="composer">
          {error ? <div className="error">{error}</div> : null}
          <div className="composer-row">
            <textarea
              className="input"
              placeholder="Escribe tu mensaje..."
              value={input}
              onChange={(e) => setInput(e.target.value)}
              onKeyDown={(e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                  e.preventDefault()
                  onSend()
                }
              }}
              rows={2}
              disabled={loading}
            />
            <button className="btn primary" onClick={onSend} disabled={loading || !input.trim()}>
              Enviar
            </button>
          </div>
          <div className="muted">Enter para enviar · Shift+Enter para salto de línea</div>
        </footer>
      </main>
    </div>
  )
}

================================================================================
FILE: src/api.js
================================================================================
const API_BASE =
  (import.meta.env.VITE_API_BASE_URL && import.meta.env.VITE_API_BASE_URL.trim()) ||
  '' // usar proxy de Vite (misma origin)

async function apiGet(path) {
  const res = await fetch(`${API_BASE}${path}`)
  if (!res.ok) throw new Error(await res.text())
  return res.json()
}

async function apiPost(path, body, opts = {}) {
  const res = await fetch(`${API_BASE}${path}`, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json', ...(opts.headers || {}) },
    body: JSON.stringify(body || {}),
  })
  if (!res.ok) throw new Error(await res.text())
  return res
}

async function apiPatch(path, body, opts = {}) {
  const res = await fetch(`${API_BASE}${path}`, {
    method: 'PATCH',
    headers: { 'Content-Type': 'application/json', ...(opts.headers || {}) },
    body: JSON.stringify(body || {}),
  })
  if (!res.ok) throw new Error(await res.text())
  return res
}

async function apiDelete(path, opts = {}) {
  const res = await fetch(`${API_BASE}${path}`, {
    method: 'DELETE',
    headers: { ...(opts.headers || {}) },
  })
  if (!res.ok) throw new Error(await res.text())
  return res
}

export async function listSessions() {
  return apiGet('/api/sessions/')
}

export async function createSession(arg = '') {
  // Compat: antes era createSession(title: string)
  // Ahora soporta createSession({ title, custom_instructions })
  const body =
    typeof arg === 'string'
      ? { title: arg }
      : (arg && typeof arg === 'object' ? arg : {})

  const res = await apiPost('/api/sessions/', body)
  return res.json()
}

export async function updateSession(sessionId, patch) {
  const res = await apiPatch(`/api/sessions/${sessionId}/`, patch || {})
  return res.json()
}

export async function deleteSession(sessionId) {
  await apiDelete(`/api/sessions/${sessionId}/`)
  return true
}

export async function getMessages(sessionId) {
  return apiGet(`/api/sessions/${sessionId}/messages/`)
}

/**
 * Streaming SSE via POST fetch (backend devuelve text/event-stream).
 * Retorna el texto final.
 */
export async function sendMessageStream(sessionId, content, onDelta) {
  const res = await apiPost(`/api/sessions/${sessionId}/chat/?stream=1`, { content })
  const reader = res.body.getReader()
  const decoder = new TextDecoder('utf-8')
  let buffer = ''
  let full = ''

  while (true) {
    const { value, done } = await reader.read()
    if (done) break
    buffer += decoder.decode(value, { stream: true })

    const events = buffer.split('\n\n')
    buffer = events.pop() || ''

    for (const evt of events) {
      const lines = evt.split('\n')
      for (const line of lines) {
        if (!line.startsWith('data: ')) continue
        const payload = line.slice(6).trim()
        if (payload === '[DONE]') continue
        try {
          const obj = JSON.parse(payload)
          if (obj.error) throw new Error(obj.error)
          if (obj.delta) {
            full += obj.delta
            onDelta?.(obj.delta)
          }
        } catch (e) {
          // si no es JSON, ignorar
        }
      }
    }
  }

  return full
}

export async function sendMessage(sessionId, content) {
  const res = await apiPost(`/api/sessions/${sessionId}/chat/`, { content })
  const data = await res.json()
  return data.assistant || ''
}

================================================================================
FILE: src/main.jsx
================================================================================
import React from 'react'
import ReactDOM from 'react-dom/client'
import App from './App.jsx'
import './styles.css'

ReactDOM.createRoot(document.getElementById('root')).render(
  <React.StrictMode>
    <App />
  </React.StrictMode>,
)


